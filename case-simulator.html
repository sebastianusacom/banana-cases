<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banana Cases RTP Simulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .variance-level-card {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border-left: 4px solid #ff4757;
        }

        .variance-level-card .stat-value {
            color: white;
            font-size: 1.8em;
            font-weight: bold;
        }

        .variance-level-card .stat-label {
            color: rgba(255,255,255,0.9);
        }

        .variance-dots {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 10px;
        }

        .variance-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        .variance-dot.active {
            background: white;
            transform: scale(1.2);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .prize-input {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .prize-input input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .prize-input input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .case-price {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
        }

        .case-price label {
            font-weight: bold;
            font-size: 18px;
        }

        .case-price input {
            padding: 10px 15px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 16px;
            width: 120px;
        }

        .simulation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .sim-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .sim-btn:hover {
            background: #0056b3;
        }

        .sim-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .simulation-results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .results-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .results-section h4 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .result-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .import-export {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .import-export textarea {
            flex: 1;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }

        .import-export button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .profit { color: #28a745; }
        .loss { color: #dc3545; }
        .neutral { color: #6c757d; }

        .individual-sim {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .case-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .case-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .case-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .case-btn:active {
            transform: translateY(0);
        }

        .case-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .case-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .case-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .case-card.revealed {
            transform: scale(1);
            opacity: 1;
        }

        .case-card.jackpot {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            animation: jackpotGlow 1s ease-in-out infinite alternate;
        }

        @keyframes jackpotGlow {
            from { box-shadow: 0 8px 25px rgba(255,215,0,0.3); }
            to { box-shadow: 0 8px 25px rgba(255,215,0,0.8); }
        }

        .case-name {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .case-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .case-profit {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }

        .total-result {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .total-amount {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .reveal-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }

        .case-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .case-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .case-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .case-btn:active {
            transform: translateY(0);
        }

        .case-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .case-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .case-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .case-card.revealed {
            transform: scale(1);
            opacity: 1;
        }

        .case-card.jackpot {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            animation: jackpotGlow 1s ease-in-out infinite alternate;
        }

        @keyframes jackpotGlow {
            from { box-shadow: 0 8px 25px rgba(255,215,0,0.3); }
            to { box-shadow: 0 8px 25px rgba(255,215,0,0.8); }
        }

        .case-name {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .case-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .case-profit {
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }

        .total-result {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .total-amount {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .reveal-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: bold;
            color: #333;
            pointer-events: none;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>游꼛 Banana Cases RTP Simulator</h1>

        <div id="warnings"></div>

        <div class="case-price">
            <label>Case Price:</label>
            <input type="number" id="casePrice" value="250" min="1" step="1">
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <div class="import-export">
            <textarea id="configTextarea" placeholder="Paste configuration JSON here to import..."></textarea>
            <div>
                <button onclick="importConfig()">Import</button>
                <button onclick="exportConfig()">Export</button>
            </div>
        </div>

        <h2>Prizes</h2>
        <div id="prizesContainer">
            <!-- Prize inputs will be populated by JavaScript -->
        </div>
        <button class="add-btn" onclick="addPrize()">+ Add Prize</button>

        <div class="individual-sim">
            <h2>游꾸 Individual Case Opening</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Experience the thrill of opening cases one by one!</p>

            <div class="case-buttons">
                <button class="case-btn" onclick="openCases(1)">1x Case<br><small>Cost: $<span id="cost1x">250</span></small></button>
                <button class="case-btn" onclick="openCases(2)">2x Cases<br><small>Cost: $<span id="cost2x">500</span></small></button>
                <button class="case-btn" onclick="openCases(3)">3x Cases<br><small>Cost: $<span id="cost3x">750</span></small></button>
            </div>

            <div id="caseResults" style="display: none;">
                <div class="case-display" id="caseDisplay">
                    <!-- Individual case results will appear here -->
                </div>

                <div class="total-result">
                    <h3>Session Total</h3>
                    <div class="total-amount" id="sessionTotal">$0</div>
                    <div id="sessionProfit" class="case-profit neutral">Break Even</div>
                </div>
            </div>
        </div>

        <div class="simulation-results" id="simulationResults" style="display: none;">
            <h3>Simulation Results</h3>
            <div class="results-grid" id="resultsGrid">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>

        <div class="simulation-controls">
            <label>Number of simulations:</label>
            <input type="number" id="simCount" value="1000" min="1" max="100000">
            <button class="sim-btn" onclick="runSimulation()">Run Simulation</button>
            <button class="sim-btn" onclick="clearResults()">Clear Results</button>
            <button class="sim-btn" onclick="exportConfiguration()">Export Config</button>
        </div>
    </div>

    <script>
        let prizes = [
            { name: 'Stars', value: 10, chance: 69.29 },
            { name: 'Snoop Dogg', value: 350, chance: 28.5 },
            { name: 'Diamond Ring', value: 2000, chance: 2.0 },
            { name: 'Nail Bracelet', value: 9400, chance: 0.2 },
            { name: 'Plush Pepe', value: 100000, chance: 0.01 }
        ];

        function updateStats() {
            const casePrice = parseFloat(document.getElementById('casePrice').value) || 0;
            const warnings = document.getElementById('warnings');
            warnings.innerHTML = '';

            // Validate chances sum to 100
            const totalChance = prizes.reduce((sum, p) => sum + (parseFloat(p.chance) || 0), 0);
            if (Math.abs(totalChance - 100) > 0.01) {
                warnings.innerHTML = `<div class="warning">丘멆잺 Warning: Total chance is ${totalChance.toFixed(2)}% (should be 100%)</div>`;
            }

            // Calculate RTP
            const rtp = prizes.reduce((sum, p) => sum + (parseFloat(p.value) || 0) * (parseFloat(p.chance) || 0) / 100, 0);

            // Calculate house edge
            const houseEdge = 1 - (rtp / casePrice);

            // Calculate hit frequency (probability of winning more than cost)
            const hitFrequency = prizes
                .filter(p => parseFloat(p.value) > casePrice)
                .reduce((sum, p) => sum + (parseFloat(p.chance) || 0), 0) / 100;

            // Calculate variance
            const expectedValue = rtp;
            const expectedValueSquared = prizes.reduce((sum, p) => {
                const value = parseFloat(p.value) || 0;
                const prob = (parseFloat(p.chance) || 0) / 100;
                return sum + value * value * prob;
            }, 0);
            const variance = expectedValueSquared - expectedValue * expectedValue;

            // Calculate variance level (1-5 scale)
            // Use coefficient of variation: standard deviation / expected value
            const stdDev = Math.sqrt(variance);
            const coefficientOfVariation = casePrice > 0 ? stdDev / casePrice : 0;

            let varianceLevel, varianceLabel;
            if (coefficientOfVariation < 0.5) {
                varianceLevel = 1;
                varianceLabel = "Very Low";
            } else if (coefficientOfVariation < 1.0) {
                varianceLevel = 2;
                varianceLabel = "Low";
            } else if (coefficientOfVariation < 2.0) {
                varianceLevel = 3;
                varianceLabel = "Medium";
            } else if (coefficientOfVariation < 4.0) {
                varianceLevel = 4;
                varianceLabel = "High";
            } else {
                varianceLevel = 5;
                varianceLabel = "Very High";
            }

            // Expected profit per spin
            const expectedProfit = casePrice * houseEdge;

            const stats = [
                { label: 'RTP', value: `${(rtp / casePrice * 100).toFixed(2)}%`, raw: rtp / casePrice },
                { label: 'House Edge', value: `${(houseEdge * 100).toFixed(2)}%`, raw: houseEdge },
                { label: 'Hit Frequency', value: `${(hitFrequency * 100).toFixed(2)}%`, raw: hitFrequency },
                { label: 'Variance Level', value: `${varianceLabel} (${varianceLevel}/5)`, raw: varianceLevel, varianceLevel: varianceLevel },
                { label: 'Variance', value: variance.toFixed(2), raw: variance },
                { label: 'Expected Value', value: `$${rtp.toFixed(2)}`, raw: rtp },
                { label: 'Expected Profit/Spin', value: `$${expectedProfit.toFixed(2)}`, raw: expectedProfit }
            ];

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card ${stat.varianceLevel ? 'variance-level-card' : ''}">
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    ${stat.varianceLevel ? `
                        <div class="variance-dots">
                            ${[1,2,3,4,5].map(level => `
                                <div class="variance-dot ${level <= stat.varianceLevel ? 'active' : ''}"></div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderPrizes() {
            const container = document.getElementById('prizesContainer');
            container.innerHTML = prizes.map((prize, index) => `
                <div class="prize-input">
                    <input type="text" placeholder="Prize name" value="${prize.name}"
                           onchange="updatePrize(${index}, 'name', this.value)">
                    <input type="number" placeholder="Value" value="${prize.value}" min="0" step="1"
                           onchange="updatePrize(${index}, 'value', this.value)">
                    <input type="number" placeholder="Chance %" value="${prize.chance}" min="0" max="100" step="0.01"
                           onchange="updatePrize(${index}, 'chance', this.value)">
                    <button class="remove-btn" onclick="removePrize(${index})">Remove</button>
                </div>
            `).join('');
            updateStats();
        }

        function addPrize() {
            prizes.push({ name: 'New Prize', value: 100, chance: 1 });
            renderPrizes();
        }

        function removePrize(index) {
            if (prizes.length > 1) {
                prizes.splice(index, 1);
                renderPrizes();
            }
        }

        function updatePrize(index, field, value) {
            prizes[index][field] = value;
            updateStats();
        }

        function pickWinner(items) {
            const totalChance = items.reduce((sum, item) => sum + (parseFloat(item.chance) || 0), 0);
            let rand = Math.random() * totalChance;

            for (const item of items) {
                rand -= parseFloat(item.chance) || 0;
                if (rand <= 0) {
                    return item;
                }
            }

            return items[items.length - 1];
        }

        function runSimulation() {
            const simCount = parseInt(document.getElementById('simCount').value) || 1000;
            const casePrice = parseFloat(document.getElementById('casePrice').value) || 0;

            let totalSpent = 0;
            let totalWon = 0;
            let wins = 0;
            let losses = 0;
            let profitDistribution = {};
            let prizeDistribution = {};

            // Initialize prize distribution tracker
            prizes.forEach(prize => {
                prizeDistribution[prize.name] = 0;
            });

            for (let i = 0; i < simCount; i++) {
                totalSpent += casePrice;
                const winner = pickWinner(prizes);
                const winAmount = parseFloat(winner.value) || 0;
                totalWon += winAmount;

                // Track prize distribution
                prizeDistribution[winner.name]++;

                if (winAmount > casePrice) {
                    wins++;
                } else {
                    losses++;
                }

                const profit = winAmount - casePrice;
                if (!profitDistribution[profit]) {
                    profitDistribution[profit] = 0;
                }
                profitDistribution[profit]++;
            }

            const netProfit = totalWon - totalSpent;
            const winRate = (wins / simCount) * 100;
            const avgWin = wins > 0 ? totalWon / wins : 0;

            // Sort profit distribution by frequency
            const sortedProfits = Object.entries(profitDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Create prize distribution results
            const prizeResults = Object.entries(prizeDistribution)
                .sort((a, b) => b[1] - a[1])
                .map(([prizeName, count]) => {
                    const percentage = ((count / simCount) * 100).toFixed(1);
                    return { label: `${prizeName}`, value: `${count} (${percentage}%)`, class: 'neutral' };
                });

            const houseProfit = totalSpent - totalWon;

            const results = [
                { label: 'Total Spent', value: `$${totalSpent.toLocaleString()}`, class: 'neutral' },
                { label: 'Total Won', value: `$${totalWon.toLocaleString()}`, class: 'neutral' },
                { label: 'House Profit', value: `$${houseProfit.toLocaleString()}`, class: houseProfit > 0 ? 'profit' : 'neutral' },
                { label: 'Net Profit', value: `$${netProfit.toLocaleString()}`, class: netProfit >= 0 ? 'profit' : 'loss' },
                { label: 'Win Rate', value: `${winRate.toFixed(1)}%`, class: 'neutral' },
                { label: 'Avg Win Amount', value: `$${avgWin.toFixed(2)}`, class: 'neutral' },
                { label: 'Most Common Outcome', value: sortedProfits[0] ? `$${parseFloat(sortedProfits[0][0]).toFixed(2)} (${sortedProfits[0][1]} times)` : 'N/A', class: 'neutral' }
            ];

            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = `
                <div class="results-section">
                    <h4 style="grid-column: 1 / -1; margin: 0 0 15px 0; color: #333;">游늵 Overall Statistics</h4>
                    ${results.map(result => `
                        <div class="result-item ${result.class}">
                            <div style="font-weight: bold;">${result.label}</div>
                            <div>${result.value}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="results-section">
                    <h4 style="grid-column: 1 / -1; margin: 15px 0 15px 0; color: #333;">游꾸 Prize Distribution</h4>
                    ${prizeResults.map(result => `
                        <div class="result-item ${result.class}">
                            <div style="font-weight: bold;">${result.label}</div>
                            <div>${result.value}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('simulationResults').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('simulationResults').style.display = 'none';
        }

        function exportConfiguration() {
            const casePrice = parseFloat(document.getElementById('casePrice').value) || 0;

            // Calculate current stats
            const totalChance = prizes.reduce((sum, p) => sum + (parseFloat(p.chance) || 0), 0);
            const rtp = prizes.reduce((sum, p) => sum + (parseFloat(p.value) || 0) * (parseFloat(p.chance) || 0) / 100, 0);
            const houseEdge = 1 - (rtp / casePrice);
            const hitFrequency = prizes
                .filter(p => parseFloat(p.value) > casePrice)
                .reduce((sum, p) => sum + (parseFloat(p.chance) || 0), 0) / 100;

            const expectedValue = rtp;
            const expectedValueSquared = prizes.reduce((sum, p) => {
                const value = parseFloat(p.value) || 0;
                const prob = (parseFloat(p.chance) || 0) / 100;
                return sum + value * value * prob;
            }, 0);
            const variance = expectedValueSquared - expectedValue * expectedValue;

            // Calculate normalized probabilities
            const normalizedPrizes = prizes.map(prize => ({
                ...prize,
                normalizedChance: totalChance > 0 ? (parseFloat(prize.chance) || 0) / totalChance * 100 : 0
            }));

            const config = {
                exportDate: new Date().toISOString(),
                configuration: {
                    casePrice: casePrice,
                    totalConfiguredChance: totalChance,
                    prizes: normalizedPrizes
                },
                calculatedStats: {
                    rtp: {
                        percentage: (rtp / casePrice * 100).toFixed(2) + '%',
                        dollarValue: rtp.toFixed(2),
                        perCase: (rtp / casePrice).toFixed(4)
                    },
                    houseEdge: {
                        percentage: (houseEdge * 100).toFixed(2) + '%',
                        dollarValue: (casePrice * houseEdge).toFixed(2),
                        perCase: houseEdge.toFixed(4)
                    },
                    hitFrequency: (hitFrequency * 100).toFixed(2) + '%',
                    variance: variance.toFixed(2),
                    expectedValue: rtp.toFixed(2),
                    expectedProfitPerSpin: (casePrice * houseEdge).toFixed(2)
                },
                prizeOdds: normalizedPrizes.map(prize => ({
                    name: prize.name,
                    value: prize.value,
                    configuredChance: prize.chance + '%',
                    normalizedChance: prize.normalizedChance.toFixed(4) + '%',
                    odds: prize.normalizedChance > 0 ? `1 in ${(100 / prize.normalizedChance).toFixed(1)}` : 'Never',
                    expectedValue: ((parseFloat(prize.value) || 0) * prize.normalizedChance / 100).toFixed(2)
                }))
            };

            // Create and download JSON file
            const dataStr = JSON.stringify(config, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `case-config-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function openCases(count) {
            const casePrice = parseFloat(document.getElementById('casePrice').value) || 0;
            const totalCost = casePrice * count;

            // Disable buttons during animation
            document.querySelectorAll('.case-btn').forEach(btn => btn.disabled = true);

            const results = [];
            let totalWon = 0;

            for (let i = 0; i < count; i++) {
                const winner = pickWinner(prizes);
                const winAmount = parseFloat(winner.value) || 0;
                totalWon += winAmount;
                results.push({
                    name: winner.name,
                    value: winAmount,
                    image: winner.image || '游꾸',
                    isJackpot: winAmount >= casePrice * 10 // Consider prizes 10x case price as jackpot
                });
            }

            // Show results with animation
            showCaseResults(results, totalCost, totalWon);

            // Re-enable buttons after animation
            setTimeout(() => {
                document.querySelectorAll('.case-btn').forEach(btn => btn.disabled = false);
            }, 2000 + (count * 500));
        }

        function showCaseResults(results, totalCost, totalWon) {
            const caseDisplay = document.getElementById('caseDisplay');
            const caseResults = document.getElementById('caseResults');
            const sessionTotal = document.getElementById('sessionTotal');
            const sessionProfit = document.getElementById('sessionProfit');

            caseResults.style.display = 'block';

            // Clear previous results
            caseDisplay.innerHTML = '';

            // Create case cards
            results.forEach((result, index) => {
                const caseCard = document.createElement('div');
                caseCard.className = 'case-card';
                caseCard.innerHTML = `
                    <div class="reveal-text">游꾸 Opening...</div>
                `;

                caseDisplay.appendChild(caseCard);

                // Animate reveal
                setTimeout(() => {
                    caseCard.classList.add('revealed');
                    if (result.isJackpot) {
                        caseCard.classList.add('jackpot');
                    }

                    const profit = result.value - totalCost / results.length;
                    const profitClass = profit > 0 ? 'profit' : profit < 0 ? 'loss' : 'neutral';
                    const profitText = profit > 0 ? `+$${profit.toFixed(2)}` : profit < 0 ? `-$${Math.abs(profit).toFixed(2)}` : 'Break Even';

                    caseCard.innerHTML = `
                        <div class="case-name">${result.name}</div>
                        <div class="case-value">$${result.value.toLocaleString()}</div>
                        <div class="case-profit ${profitClass}">${profitText}</div>
                    `;
                }, 500 + (index * 300));
            });

            // Update total
            setTimeout(() => {
                const netProfit = totalWon - totalCost;
                const profitClass = netProfit > 0 ? 'profit' : netProfit < 0 ? 'loss' : 'neutral';
                const profitText = netProfit > 0 ? `+$${netProfit.toFixed(2)}` : netProfit < 0 ? `-$${Math.abs(netProfit).toFixed(2)}` : 'Break Even';

                sessionTotal.textContent = `$${totalWon.toLocaleString()}`;
                sessionProfit.className = `case-profit ${profitClass}`;
                sessionProfit.textContent = profitText;
            }, 500 + (results.length * 300));
        }

        function updateCosts() {
            const casePrice = parseFloat(document.getElementById('casePrice').value) || 0;
            document.getElementById('cost1x').textContent = casePrice.toFixed(0);
            document.getElementById('cost2x').textContent = (casePrice * 2).toFixed(0);
            document.getElementById('cost3x').textContent = (casePrice * 3).toFixed(0);
        }

        function exportConfig() {
            const config = {
                casePrice: parseFloat(document.getElementById('casePrice').value),
                prizes: prizes
            };
            document.getElementById('configTextarea').value = JSON.stringify(config, null, 2);
        }

        function importConfig() {
            try {
                const config = JSON.parse(document.getElementById('configTextarea').value);
                document.getElementById('casePrice').value = config.casePrice;
                prizes = config.prizes;
                renderPrizes();
                updateCosts();
            } catch (e) {
                alert('Invalid JSON configuration');
            }
        }

        // Initialize
        renderPrizes();
        updateCosts();
        document.getElementById('casePrice').addEventListener('input', () => {
            updateStats();
            updateCosts();
        });
    </script>
</body>
</html>
